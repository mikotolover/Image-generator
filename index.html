<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì¤‘ ì´ë¯¸ì§€ ë©”ì´ì»¤</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; line-height: 1.6; background-color: #f4f4f9; }
        /* containerì— relative í¬ì§€ì…˜ ì¶”ê°€: ë²„íŠ¼ì„ ì ˆëŒ€ ìœ„ì¹˜ë¡œ ë°°ì¹˜í•˜ê¸° ìœ„í•¨ */
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            border: 1px solid #ccc; 
            padding: 20px; 
            border-radius: 10px; 
            background: white;
            position: relative; /* ì¤‘ìš” */
        }
        
        /* ìƒˆë¡œ ì¶”ê°€ëœ ë¯¸ë¦¬ë³´ê¸° í† ê¸€ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        #previewToggleBtn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: transparent;
            border: none;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: auto; /* ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë®ì–´ì“°ê¸° */
            height: auto;
            color: #333;
            transition: transform 0.3s ease;
        }
        #previewToggleBtn:hover {
            background: transparent;
            transform: scale(1.1) rotate(15deg);
        }

        input { margin: 10px 0; width: 95%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;}
        button.gen-btn { background: #007BFF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; margin-top: 10px;}
        button.gen-btn:hover { background: #0056b3; }
        
        /* ìº”ë²„ìŠ¤ ìŠ¤íƒ€ì¼ ìˆ˜ì • ë° ë°°ê²½ìƒ‰ ì „í™˜ íŠ¸ëœì§€ì…˜ ì¶”ê°€ */
        canvas { 
            max-width: 100%; 
            margin-top: 20px; 
            border: 1px solid #eee; 
            /* ë°°ê²½ìƒ‰ì´ ë¶€ë“œëŸ½ê²Œ ë°”ë€Œë„ë¡ ì„¤ì • */
            transition: background-color 0.3s ease, border-color 0.3s ease;
            /* ê¸°ë³¸ ë°ì€ ë°°ê²½ (íˆ¬ëª…/í°ìƒ‰) */
            background-color: #ffffff;
            background-image: linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee), linear-gradient(45deg, #eee 25%, transparent 25%, transparent 75%, #eee 75%, #eee);
            background-size: 20px 20px;
            background-position: 0 0, 10px 10px;
        }

        /* ë‹¤í¬ ëª¨ë“œ ë¯¸ë¦¬ë³´ê¸° í´ë˜ìŠ¤ */
        canvas.dark-preview {
            background-color: #222222; /* ì–´ë‘ìš´ ë°°ê²½ìƒ‰ */
            background-image: none; /* ì²´í¬ë¬´ëŠ¬ ì œê±° */
            border-color: #444;
        }

        #downloadBtn { display: none; background: #28a745; margin-top: 15px; text-decoration: none; color: white; padding: 12px; border-radius: 5px; font-weight: bold; display: block; width: 100%; box-sizing: border-box;}
        #downloadBtn:hover { background: #218838; }
        .hidden { display: none !important; }
    </style>
</head>
<body>

<div class="container">
    <button id="previewToggleBtn" title="ë°°ê²½ìƒ‰ ì „í™˜ (ë‹¤í¬/ë¼ì´íŠ¸)">ğŸŒ‘</button>

    <h2>ğŸŒ“ ì´ì¤‘ ì´ë¯¸ì§€ ë©”ì´ì»¤</h2>
    <p>ë‹¤í¬ëª¨ë“œì—ì„œ ë³´ì¼ ì´ë¯¸ì§€ì™€ ë¼ì´íŠ¸ëª¨ë“œì—ì„œ ë³´ì¼ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
    
    <div style="text-align: left; display: inline-block; width: 100%;">
        <label>ğŸŒ‘ ë‹¤í¬ ëª¨ë“œìš© ì´ë¯¸ì§€:</label>
        <input type="file" id="darkInput" accept="image/*">
        
        <label>â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œìš© ì´ë¯¸ì§€:</label>
        <input type="file" id="lightInput" accept="image/*">
    </div>
    
    <button class="gen-btn" onclick="processImages()">ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</button>
    
    <canvas id="resultCanvas"></canvas>
    <a id="downloadBtn" class="hidden">ê²°ê³¼ ì €ì¥í•˜ê¸°</a>
</div>

<script>
// --- ê¸°ëŠ¥ ì¶”ê°€ ë¶€ë¶„ ì‹œì‘ ---
let isDarkModePreview = false;
const toggleBtn = document.getElementById('previewToggleBtn');
const canvasElement = document.getElementById('resultCanvas');

toggleBtn.addEventListener('click', () => {
    isDarkModePreview = !isDarkModePreview;
    if (isDarkModePreview) {
        // ë‹¤í¬ ëª¨ë“œ ë¯¸ë¦¬ë³´ê¸° ì¼œê¸°
        canvasElement.classList.add('dark-preview');
        toggleBtn.textContent = 'â˜€ï¸'; // ì•„ì´ì½˜ì„ í•´ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½
    } else {
        // ë¼ì´íŠ¸ ëª¨ë“œ ë¯¸ë¦¬ë³´ê¸° ì¼œê¸° (ê¸°ë³¸)
        canvasElement.classList.remove('dark-preview');
        toggleBtn.textContent = 'ğŸŒ‘'; // ì•„ì´ì½˜ì„ ë‹¬ ëª¨ì–‘ìœ¼ë¡œ ë³€ê²½
    }
});
// --- ê¸°ëŠ¥ ì¶”ê°€ ë¶€ë¶„ ë ---


async function processImages() {
    const darkFile = document.getElementById('darkInput').files[0];
    const lightFile = document.getElementById('lightInput').files[0];
    const downloadBtn = document.getElementById('downloadBtn');

    if (!darkFile || !lightFile) {
        alert("ì´ë¯¸ì§€ ë‘ ê°œë¥¼ ëª¨ë‘ ê³¨ë¼ì£¼ì„¸ìš”");
        return;
    }

    // ì´ë¯¸ì§€ ì²˜ë¦¬ ì¤‘ ë¡œë”© í‘œì‹œ ë“±ì„ ì›í•œë‹¤ë©´ ì—¬ê¸°ì— ì¶”ê°€

    const loadImage = (file) => new Promise((resolve) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
            URL.revokeObjectURL(url);
            resolve(img);
        };
        img.src = url;
    });

    const [imgD, imgL] = await Promise.all([loadImage(darkFile), loadImage(lightFile)]);

    const canvas = document.getElementById('resultCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const width = Math.min(imgD.width, imgL.width);
    const height = Math.min(imgD.height, imgL.height);
    canvas.width = width;
    canvas.height = height;

    ctx.drawImage(imgD, 0, 0, width, height);
    const dataD = ctx.getImageData(0, 0, width, height).data;
    
    ctx.clearRect(0, 0, width, height);
    ctx.drawImage(imgL, 0, 0, width, height);
    const dataL = ctx.getImageData(0, 0, width, height).data;

    const output = ctx.createImageData(width, height);
    const d = output.data;

    for (let i = 0; i < d.length; i += 4) {
        const gD = (dataD[i] + dataD[i+1] + dataD[i+2]) / 765;
        const gL = (dataL[i] + dataL[i+1] + dataL[i+2]) / 765;

        const c_black = gD * 0.5;
        const c_white = gL * 0.5 + 0.5;

        let alpha = Math.max(0.001, Math.min(1.0, 1.0 - (c_white - c_black)));
        let c_src = Math.max(0, Math.min(255, (c_black / alpha) * 255));

        d[i] = d[i+1] = d[i+2] = c_src;
        d[i+3] = alpha * 255;
    }

    ctx.putImageData(output, 0, 0);

    const now = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    
    downloadBtn.href = canvas.toDataURL("image/png");
    downloadBtn.download = `dual_image_${timestamp}.png`;
    downloadBtn.classList.remove('hidden'); // ìƒì„± í›„ ë²„íŠ¼ í‘œì‹œ
}
</script>

</body>
</html>
