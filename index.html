<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì´ì¤‘ ì´ë¯¸ì§€ ë©”ì´ì»¤</title>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; line-height: 1.6; }
        .container { max-width: 500px; margin: 0 auto; border: 1px solid #ccc; padding: 20px; border-radius: 10px; }
        input { margin: 10px 0; width: 100%; }
        button { background: #007BFF; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; width: 100%; font-size: 16px; }
        button:hover { background: #0056b3; }
        canvas { max-width: 100%; margin-top: 20px; border: 1px solid #eee; }
        #downloadBtn { display: none; background: #28a745; margin-top: 10px; text-decoration: none; color: white; padding: 10px; border-radius: 5px; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸŒ“ ì´ì¤‘ ì´ë¯¸ì§€ ë©”ì´ì»¤</h2>
    <p>ë¼ì´íŠ¸ëª¨ë“œì—ì„œ ë³´ì¼ ì´ë¯¸ì§€ì™€ ë‹¤í¬ëª¨ë“œì—ì„œ ë³´ì¼ ì´ë¯¸ì§€ë¥¼ ì„ íƒí•˜ì„¸ìš”.</p>
    
    <label>â˜€ï¸ ë¼ì´íŠ¸ ëª¨ë“œ:</label>
    <input type="file" id="lightInput" accept="image/*">
    
    <label>ğŸŒ‘ ë‹¤í¬ ëª¨ë“œ:</label>
    <input type="file" id="darkInput" accept="image/*">
    
    <button onclick="processImages()">ì´ë¯¸ì§€ ìƒì„±í•˜ê¸°</button>
    
    <canvas id="resultCanvas"></canvas>
    <a id="downloadBtn">ê²°ê³¼ ì €ì¥í•˜ê¸°</a>
</div>

<script>
async function processImages() {
    const darkFile = document.getElementById('darkInput').files[0];
    const lightFile = document.getElementById('lightInput').files[0];

    if (!darkFile || !lightFile) {
        alert("ì´ë¯¸ì§€ ë‘ ê°œë¥¼ ëª¨ë‘ ê³¨ë¼ì£¼ì„¸ìš”");
        return;
    }

    const loadImage = (file) => new Promise((resolve) => {
        const img = new Image();
        const url = URL.createObjectURL(file);
        img.onload = () => {
            URL.revokeObjectURL(url);
            resolve(img);
        };
        img.src = url;
    });

    const [imgD, imgL] = await Promise.all([loadImage(darkFile), loadImage(lightFile)]);

    const canvas = document.getElementById('resultCanvas');
    const ctx = canvas.getContext('2d', { willReadFrequently: true });

    const width = Math.min(imgD.width, imgL.width);
    const height = Math.min(imgD.height, imgL.height);
    canvas.width = width;
    canvas.height = height;

    ctx.drawImage(imgD, 0, 0, width, height);
    const dataD = ctx.getImageData(0, 0, width, height).data;
    
    ctx.clearRect(0, 0, width, height);
    ctx.drawImage(imgL, 0, 0, width, height);
    const dataL = ctx.getImageData(0, 0, width, height).data;

    const output = ctx.createImageData(width, height);
    const d = output.data;

    for (let i = 0; i < d.length; i += 4) {
        const gD = (dataD[i] + dataD[i+1] + dataD[i+2]) / 765;
        const gL = (dataL[i] + dataL[i+1] + dataL[i+2]) / 765;

        const c_black = gD * 0.5;
        const c_white = gL * 0.5 + 0.5;

        let alpha = Math.max(0.001, Math.min(1.0, 1.0 - (c_white - c_black)));
        let c_src = Math.max(0, Math.min(255, (c_black / alpha) * 255));

        d[i] = d[i+1] = d[i+2] = c_src;
        d[i+3] = alpha * 255;
    }

    ctx.putImageData(output, 0, 0);

    const now = new Date();
    const pad = (n) => String(n).padStart(2, '0');
    const timestamp = `${now.getFullYear()}${pad(now.getMonth() + 1)}${pad(now.getDate())}_${pad(now.getHours())}${pad(now.getMinutes())}${pad(now.getSeconds())}`;
    
    const downloadBtn = document.getElementById('downloadBtn');
    downloadBtn.href = canvas.toDataURL("image/png");
    downloadBtn.download = `dual_image_${timestamp}.png`;
    downloadBtn.style.display = "block";
}
</script>

</body>
</html>
